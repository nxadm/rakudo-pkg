<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>rakudo-pkg latest release</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript">

    function parse_query_string(query) {
      var vars = query.split("&");
      var query_string = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        // If first entry with this name
        if (typeof query_string[pair[0]] === "undefined") {
          query_string[pair[0]] = decodeURIComponent(pair[1]);
          // If second entry with this name
        } else if (typeof query_string[pair[0]] === "string") {
          var arr = [query_string[pair[0]], decodeURIComponent(pair[1])];
          query_string[pair[0]] = arr;
          // If third or later entry with this name
        } else {
          query_string[pair[0]].push(decodeURIComponent(pair[1]));
        }
      }
      return query_string;
    }

    function get_latest_release(repo, os, version, arch) {
       $.getJSON(repo).done(function (json) {
            var assets = json.assets;
            var regex_pkgs = new RegExp(".*" + os + version + ".*" + arch + ".*");
            var regex_sha  = new RegExp(".*\.sha1$");

            for (var i = 0, len = assets.length; i < len; i++) {
              if (regex_pkgs.test(assets[i].name)) {
                if (regex_sha.test(assets[i].name)) {
                  console.log(assets[i]);
                  window.location.href = assets[i].browser_download_url;
                  $("#content").html(
                    "If you are not redirected automatically, " +
                    "follow the <a href='" + assets[i].browser_download_url +
                    "'>link</a></a>");
                  return;
                }
              }
            }

           $("#content").html("Couldn't find release based on: <br /><br />" +
             "<strong>os:</strong> "      + os      + "<br />" +
             "<strong>version:</strong> " + version + "<br />" +
             "<strong>arch:</strong> "    + arch    + "<br />");
       });
    }

    var query     = window.location.search.substring(1);
    var parsed_qs = parse_query_string(query);

    var defined_os      = (parsed_qs.os);
    var defined_version = (parsed_qs.version);
    var defined_arch    = (parsed_qs.arch);

    $(document).ready(function () {
        //$("#debug_GET_parameters").append(defined_os      + "<br/>");
        //$("#debug_GET_parameters").append(defined_version + "<br/>");
        //$("#debug_GET_parameters").append(defined_arch    + "<br/>");
        get_latest_release("https://api.github.com/repos/nxadm/rakudo-pkg/releases/latest", defined_os, defined_version, defined_arch);
    });
    </script>
  </head>

  <body>
    <div id='debug_GET_parameters'>
    </div>

    <div id='content'>
      Retrieving latest release ...
    </div>
  </body>
</html>
